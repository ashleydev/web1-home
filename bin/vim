#!/usr/bin/perl

use strict;
use v5.10.0;

use Cwd qw(realpath);
use File::Basename;

use constant DEBUG => 0;

my @vim_files;
my @vim_args;
my @lost_and_found;

my $flag_stdin;

# KNOWN ISSUES, PLEASE READ
# 1. this will only edit the realpath of the file if it already exists.   this is show it shows up easier in the process list
# 2. even though there are lists at the top of this file declared, they are lists in case someday Eric or Mike B want the functionality changed
#    to allow multiple editing.  If you would like to do that, make sure exec is switched to system and a foreach put in place

if (! -t STDOUT) {
  say "Preventing piping from Vim.  Exiting.";
  exit(1);
}

foreach (@ARGV) {
  
  my ($pre_colon, $post_colon) = split(/:/);

  # disallow directories
  if (-d $_) {
    say "$_ is a directory.";
    exit(1);
  } elsif (-d $pre_colon) {
    say "$pre_colon is a directory.";
    exit(1);

  } elsif (-f $_) {
    push(@vim_files, { file => $_, line => 1 });
  } elsif (-f $pre_colon && $post_colon =~ m/^[0-9]+$/) {
    push(@vim_files, { file => $pre_colon, line => $post_colon });
  } elsif (defined(my $gitfile = getPath_ab($_))) {
    push(@vim_files, { file => $gitfile, line => 1 });
  } elsif (defined(my $gitfile = getPath_ab($pre_colon)) && $post_colon =~ m/^[0-9]+$/) {
    push(@vim_files, { file => $gitfile, line => $post_colon });
  } elsif ($_ eq '-') {
    $flag_stdin = 1;
    push(@vim_args, $_);
  } elsif (m/^(\+|-)/) {
    push(@vim_args, $_);
  } else {
    push(@lost_and_found, $_);
  }

}

if (! -t STDIN && ! $flag_stdin) {
  say "Preventing piping to Vim.  Exiting.";
  exit(1);
}

my @cmd;

if (my $hashref_file_data = shift(@vim_files)) {
  my $file = $hashref_file_data->{file};
  my $file_realpath = realpath($file);
  my $line = $hashref_file_data->{line};

  unshift(@vim_args, "+$line") if ($line > 1);

  @cmd = ('vi', $file_realpath, @vim_args);

} elsif (my $first_and_only_try = shift(@lost_and_found)) {
  @cmd = ('vi', $first_and_only_try, @vim_args);
} else {
  @cmd = ('vi', @vim_args);
}

my $file_to_edit = $cmd[1];

if (-f dirname($file_to_edit) . "/." . basename($file_to_edit) . ".swp") {
  my ($user, $ip, $screen_window) = getVimPsWhoInfo("vi $file_to_edit");
  say "finding: vi $file_to_edit" if DEBUG;

  if (defined($user) && defined($ip)) {
    say "Found swap file from $user, from $ip" . (defined($screen_window) ? ", on screen window $screen_window" : '');
  } else {
    say "Found swap file, but unable to determine who is editing it.";
  }

} else {
  exec(@cmd) if @cmd;
}

# ---- getRevParseCdup getPath_ab - copied from Sjohnson::Git to not rely on external files
sub getRevParseCdup {
  my $buffer = `git rev-parse --show-cdup`;
  chomp($buffer);

  return $buffer;
}

sub getPath_ab {
  my $file = shift;

  if ($file =~ m{^(a|b)/}) {
    $file =~ s/^$&/getRevParseCdup($file)/e;

    if (-f $file) {
      return $file;
    }
  }

  return undef;
}

sub getVimPsWhoInfo {
  my $ps_query = shift;

  my $user;
  my $ip;
  my $screen_window;

  my $first_relevant_ps_line = (grep(/$ps_query/, split (/\n/, `ps aux`)))[0];
  return unless defined $first_relevant_ps_line;

  my @ps_chunks = split(' ', $first_relevant_ps_line);
  $user = $ps_chunks[0];
  my $pts = $ps_chunks[6];

  my $first_relevant_who_line = (grep(/$user \s+ $pts/x, split (/\n/, `who`)))[0];
  return unless defined($first_relevant_who_line);

  my @who_chunks = split(' ', $first_relevant_who_line);
  if ($who_chunks[5] =~ m/^\((.*?)(:S.(\d+))?\)/i) {
    $ip = $1;
    $screen_window = $3;
  }

  return ($user, $ip, $screen_window);
}
