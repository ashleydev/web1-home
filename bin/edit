#!/usr/bin/env perl

use strict;
use v5.10.0;

use Data::Dumper;

use constant DEBUG => 0;

my $which = pop(@ARGV); # only allow editing of the last arg
my $chosen_file;
my $chosen_file_linenumber;

while (<STDIN>) {
  chomp;

  if (defined($which)) {
     
    if ( $which == $.) { # find file to edit

      my @csv;
      my $index_space = index($_, ' ');
      my $index_colon = index($_, ':');

      if ($index_space > -1 && $index_colon > -1) {
	if ($index_space > $index_colon) {
	  say "one" if DEBUG;
	  @csv = split ':';
	} else {
	  say "two" if DEBUG;
	  @csv = split /\s+/;
	}
      } elsif ($index_space > -1 && $index_colon == -1) {
	say "three" if DEBUG;
	@csv = split /\s+/;
      } elsif ($index_space == -1 && $index_colon > -1) {
	say "four" if DEBUG;
	@csv = split ':';
      } else {
	say "five" if DEBUG;
	@csv = ($_);
      }

      my $i = 0;
      foreach (@csv) {
	if (-f $_) {
	  $chosen_file = $_;

	  if (DEBUG) {
	    say "\$_ var: $_";
	    say "\$csv[\$i] var: $csv[$i]";
	    printf("\$csv[\$i+1] var: %s\n", $csv[$i+1]);
	  }

	  if ($csv[$i+1] =~ m/^\d+$/) {
	    say "found a line number!" if DEBUG;
	    $chosen_file_linenumber = $&;
	  }

	  last;
	} else {
	  say "[$_] is not a file." if DEBUG;
	}
	$i++;
      }

      last;
    }

  } else {
    say "$.: $_";
  }
}

# Khisanth debugging code below
#system( "ls -l /proc/$$/fd/*" );
#exit;

if (defined($chosen_file)) {
  open STDIN, "<&=", *STDOUT or die $!;
  if (defined($chosen_file_linenumber)) {
    system($ENV{EDITOR}, $chosen_file, "+$chosen_file_linenumber")
  } else {
    system($ENV{EDITOR}, $chosen_file)
  }

} elsif ($which > $.) {
  say "Your query was higher than the number of lines.";
  exit(1);
} elsif (defined($which)) {
  say "Sorry, couldn't determine a chosen file.";
  exit(1);
}
