#!/usr/bin/perl

#### NOTES:

# 1: a day may come when i decide to make it do a diff on the file, instead of trying to edit it...
# 2: this isn't designed to git-adds... just use this only from doing a git-status report

use String::Strip;
use Data::Dumper;
use File::Basename;
use Cwd qw(realpath);
use Term::ANSIColor qw(:constants);

use strict;


# START ----------------------

my $flag_commitfile_log_path; # if defined, its path is the destination file path for writing a list of files that need to be commited

my @in;

my @files;

my @cannot_find;
my @need_to_add;
my @need_to_commit;

# sjohnson (30nov2009): fixme should be smarter, because params are being sent
if (@ARGV) {
  foreach (@ARGV) {

  if (m/^--log=(\S+)$/) {
    $flag_commitfile_log_path = $1;
    next;
  }
    push (@in, $_);
  }
}

unless (@in) {
  while (<STDIN>) {
    push (@in, $_);
  }
}

foreach (@in) {
  StripLTSpace($_);

  if (! length) { next; }


  if ( -f $_) {
    push (@files, realpath($_));
  } else {
    push(@cannot_find, $_);
  }
}

unless (@files) { exit (1); }

print "\nWorking...";

foreach (@files) {

    my $path = dirname($_);
    my $filename = basename($_);

    chdir($path);

    my $cmd_diff = "git diff $filename";
    my $cmd_status = "git status $filename 2>&1 1>/dev/null";

    my $results_status = `$cmd_status`;

#    if (system($cmd_status) > 0) {
    if ($results_status =~ m/Did you forget to 'git add'\?/) {
      push(@need_to_add, $_);
    } else {
      my $results = `$cmd_diff`; # change me in the future to a diff command or something
      StripLTSpace($results);

      if ( $results ) {
	push(@need_to_commit, $_);
      }
    }
}

print "\n\n";

{
  local $" = "\n";

  if (@cannot_find) { print RED, "Cannot find:\n", RESET, "@cannot_find\n\n", RESET; }
  if (@need_to_add) { print BOLD, GREEN, "Need to add:\n", RESET, "@need_to_add\n\n", RESET; }
  if (@need_to_commit) {
    if ($flag_commitfile_log_path) {
      open (WRITE, ">$flag_commitfile_log_path") or die ("Can't open log for writing");
      print WRITE "@need_to_commit\n";
      close(WRITE) and print "Wrote need commit log to $flag_commitfile_log_path\n";
    }
    print BOLD, BLUE, "Need to commit:\n", RESET, "@need_to_commit\n\n", RESET;
  }
}
